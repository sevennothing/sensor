/*	Sensor Board V1.0
 *  copyright?: 2013  union Power ,caijun , sevennothing@gmail.com
 *  1.Temperaure Sensor (PT100) use ADC10 sample,Vref = 1.5V;Temperaure in oC stored in IntDegC, oF in IntDegF.
 *  2.默认顺序启动电源，间隔50ms
 *  3.高电平使能电源组
 *  4.唤醒信号，定时唤醒，条件唤醒等
 *  5.外部唤醒脚连接ZIGBEE模块的紧急状态输出脚，当设备进入待机模式后发生紧急事件，立即唤醒设备
 *  6.电源管理可分组，最多分为10组，同一组内的电源轨同时关断和开启
 *  7.可设置相邻组的启动间隔时间，固定为1组到10组，设置时需要同时设置，详见命令
 *  8.
 *  note:
 *           TODO:
 *           ！！电路板运放的负电压轨没接！！！
 *           温度传感器
 *           湿度传感器
 *           光敏传感器
 *           zigebee 通信接口
 *
 *           Unused I/O pins should be configured as I/O function, output direction, and left unconnected on the PC
 *           board, to prevent a floating input and reduce power consumption
 *
 *
 *  MSP430G2253 resource
 *  ROM:4*512B=2KB
 *  RAM:256B
 *  information segment: 4*64B=256B
 *
 *
 *  PM 参数存储在信息内存中的D段,共64字节。擦除时选择独立擦除。
 *
 *  中断：命令中断(串口，IIC)，比较器中断（外部12Vdc掉电），IO中断(外部重启+外部唤醒)，定时器中断（TA0:1s  TA1:x）
 *
 *  MCU大部分时间进入LPM3模式，功耗小于2uA。
 *  什么时候休眠？休眠后所有时钟停止，只能通过外部唤醒管脚唤醒+IIC命令唤醒
 *
 */

#include <msp430.h> 

#define UART_TXD   		BIT1                    // TXD on P1.1
#define UART_RXD   		BIT2                    // RXD on P1.2

#define SEG_A               0x10C0
#define SEG_B               0x1080
#define SEG_C               0x1040
#define SEG_D               0x1000

#define TEMPERATURE		BIT0					// temperature on P1.0
#define HUMIDITY		BIT3					// humidity on P1.3
#define CHARG1			BIT1					// P3.1
#define CHARG2			BIT7					// P3.7

#define LX1				BIT4					// LX1 on P1.4
#define LX2				BIT5					// LX2 on P1.5

#define LED1			BIT5					//P3.5
#define LED2			BIT6					//P3.6


//#define USE_ALL_TEMPRATURE		0
#define USE_MANY_TEMPRATURE		1

/* define function */
#define printf(str) 	UART_print(str)

void UART_init(void)
{
	P1SEL = UART_TXD + UART_RXD;              // P1.1 = RXD, P1.2=TXD
	P1SEL2 = UART_TXD + UART_RXD;

	UCA0CTL1 |= UCSSEL_1;                     // CLK = ACLK
	UCA0BR0 = 0x03;                           // 32kHz/9600 = 3.41
	UCA0BR1 = 0x00;
	UCA0MCTL = UCBRS1 + UCBRS0;               // Modulation UCBRSx = 3
	UCA0CTL1 &= ~UCSWRST;                     // **Initialize USCI state machine**
	IE2 |= UCA0RXIE + UCA0TXIE;               // Enable USCI_A0 TX/RX interrupt

}
//------------------------------------------------------------------------------
// Outputs one byte using the Timer_A UART
//------------------------------------------------------------------------------
void UART_tx(unsigned char byte)
{
	UCA0TXBUF =  byte;
	while(!(UCA0TXIFG & IFG2));
}

//------------------------------------------------------------------------------
// Prints a string over using the Timer_A UART
//------------------------------------------------------------------------------
void UART_print(char *string)
{
    while (*string) {
        UART_tx(*string++);
    }
}

//------------------------------------------------------------------------------
// I/O init
//------------------------------------------------------------------------------
void IO_init(void)
{
	// Initialize all GPIO
	P1OUT = 0x00;
	P2OUT = 0x00;
	P3OUT = 0x00;

	P1SEL = UART_TXD + UART_RXD;            // Timer function for TXD/RXD pins
	P1DIR = 0x00;						    // Set all pins but to input

	// set all output direction
	P1DIR |=  UART_TXD;                            	// Set P1 to output direction

}

//------------------------------------------------------------------------------
// ADC init
//------------------------------------------------------------------------------
void adc_init(void)
{
	ADC10CTL0 = ADC10SHT_2 + ADC10ON + ADC10IE; // ADC10ON, interrupt enabled
	ADC10CTL1 = INCH_0;                         // input A0
	ADC10AE0 |= 0x01;                           // PA.0 ADC option select
}

void TIMA_init(void)
{
	CCTL0 = CCIE; 		//	中断使能
	CCR0 = 32768; 		//  定时时间的选取
	//CCTL1 = CCIE;   	// 开启比较器1中断
	//CCR1 = 100; 		// 3.66mS显示延迟
	TACTL = TASSEL_1 + MC_1; // 选择时钟源和计数模式,时钟源为ACLK并且为增计数模式
}
void set_tima1_ms(int t)//ACLK=32.768KHz, t = 1ms ,count=33
{
	long tt;
	tt = (32768 * t)/1000;
	CCR1 = (unsigned int)tt;
	CCTL1 = CCIE;   	// 开启比较器1中断

}



/*

 铂电阻的阻值温度之间的关系，在0～850℃范围内可用下式表示: 
	Rt =R0 (1+At+Bt2) 
在-200～0℃范围内则用下式表示， Rt =R0 [1+At+Bt2+C(t-100)3] 式中   
	Rt---温度为t℃ 时的铂电阻的阻值； 
	R0---温度为0℃ 时的铂电阻的阻值； 
	A、B、C 为常数， A=3.96847×10-3/℃；
					B=-5.847×10-7/℃； 
					C=-4.22×10-12/℃；
对满足上述关系的热电阻，其温度系数约为3.9×10-3/℃。

 */
#ifdef USE_ALL_TEMPRATURE
const unsigned int table_pt100[]={
		1852, 1895, 1938, 1982, 2025, 2068, 2111, 2154,2197, 2240, /* -200 */
		2283, 2325, 2368, 2411, 2454, 2497,	2539, 2582, 2624, 2667, /* -190 */
		2710, 2752, 2795, 2837, 2880, 2922,	2964, 3007, 3049, 3091, /* -180 */
		3134, 3176, 3218, 3260, 3302, 3344,	3386, 3428, 3470, 3512, /* -170 */
		3554, 3596, 3638, 3680, 3722, 3764,	3805, 3847, 3889, 3931, /* -160 */
		3972, 4014, 4056, 4097, 4139, 4180,	4222, 4263, 4305, 4346, /* -150 */
		4388, 4429, 4470, 4512, 4553, 4594,	4636, 4677, 4718, 4759, /* -140 */
		4800, 4842, 4883, 4924, 4965, 5006,	5047, 5088, 5129, 5170, /* -130 */
		5211, 5252, 5293, 5334, 5375, 5415,	5456, 5497, 5538, 5579, /* -120 */
		5619, 5660, 5701, 5741, 5782, 5823,	5863, 5904, 5944, 5985, /* -110 */
		6026, 6066, 6107, 6147, 6188, 6228,	6268, 6309, 6349, 6390, /* -100 */
		6430, 6470, 6511, 6551, 6591, 6631,	6672, 6712, 6752, 6792, /* -90 */
		6833, 6873, 6913, 6953, 6993, 7033,	7073, 7113, 7153, 7193, /* -80 */
		7233, 7273, 7313, 7353, 7393, 7433,	7473, 7513, 7553, 7593, /* -70 */
		7633, 7673, 7712, 7752, 7792, 7832,	7872, 7911, 7951, 7991, /* -60 */
		8031, 8070, 8110, 8150, 8189, 8229,	8269, 8308, 8348, 8387, /* -50 */
		8427, 8467, 8506, 8546, 8585, 8625, 8664, 8704, 8743, 8783, /* -40 */
		8822, 8862, 8901, 8940, 8980, 9019, 9059, 9098, 9137, 9177, /* -30 */
		9216, 9255, 9295, 9334, 9373, 9412, 9452, 9491, 9530, 9569, /* -20 */
		9609, 9648, 9687, 9726, 9765, 9804, 9844, 9883, 9922, 9961, /* -10 */
		10000, 10039, 10078, 10117,	10156, 10195, 10234, 10273, 10312, 10351, /* 0 */
		10390, 10429, 10468, 10507, 10546, 10585, 10624, 10663, 10702, 10740, /* 10 */
		10779, 10818, 10857, 10896, 10935, 10973, 11012, 11051, 11090, 11129, /* 20 */
		11167, 11206, 11245, 11283, 11322, 11361, 11400, 11438, 11477, 11515, /* 30 */
		11554, 11593, 11631, 11670, 11708, 11747, 11786, 11824, 11863, 11901, /* 40 */
		11940, 11978, 12017, 12055, 12094, 12132, 12171, 12209,	12247, 12286, /* 50 */
		12324, 12363, 12401, 12439, 12478, 12516, 12554, 12593, 12631, 12669, /* 60 */
		12708, 12746, 12784, 12822, 12861, 12899, 12937, 12975, 13013, 13052, /* 70 */
		13090, 13128, 13166, 13204, 13242, 13280, 13318, 13357, 13395, 13433, /* 80 */
		13471, 13509, 13547, 13585,	13623, 13661, 13699, 13737, 13775, 13813, /* 90 */
		13851, 13888, 13926, 13964, 14002, 14040, 14078, 14116, 14154, 14191, /* 100 */
		14229, 14267, 14305, 14343, 14380, 14418, 14456, 14494, 14531, 14569, /* 110 */
		14607, 14644, 14682, 14720, 14757, 14795, 14833, 14870, 14908, 14946, /* 120 */
		14983, 15021, 15058, 15096, 15133, 15171, 15208, 15246, 15283, 15321, /* 130 */
		15358, 15396, 15433, 15471, 15508, 15546, 15583, 15620,	15658, 15695, /* 140 */
		15733, 15770, 15807, 15845, 15882, 15919, 15956, 15994, 16031, 16068, /* 150 */
		16105, 16143, 16180, 16217, 16254, 16291, 16329, 16366, 16403, 16440, /* 160 */
		16477, 16514, 16551, 16589, 16626, 16663, 16700, 16737, 16774, 16811, /* 170 */
		16848, 16885, 16922, 16959,	16996, 17033, 17070, 17107, 17143, 17180, /* 180 */
		17217, 17254, 17291, 17328, 17365, 17402, 17438, 17475, 17512, 17549, /* 190 */
		17586, 17622, 17659, 17696, 17733, 17769, 17806, 17843, 17879, 17916, /* 200 */
		17953, 17989, 18026, 18063, 18099, 18136, 18172, 18209, 18246, 18282, /* 210 */
		18319, 18355, 18392, 18428, 18465, 18501, 18538, 18574, 18611, 18647, /* 220 */
		18684, 18720, 18756, 18793, 18829, 18866, 18902, 18938,	18975, 19011, /* 230 */
		19047, 19084, 19120, 19156, 19192, 19229, 19265, 19301, 19337, 19374, /* 240 */
		19410, 19446, 19482, 19518, 19555, 19591, 19627, 19663, 19699, 19735, /* 250 */
		19771, 19807, 19843, 19879, 19915, 19951, 19987, 20023, 20059, 20095, /* 260 */
		20131, 20167, 20203, 20239,	20275, 20311, 20347, 20383, 20419, 20455, /* 270 */
		20490, 20526, 20562, 20598, 20634, 20670, 20705, 20741, 20777, 20813, /* 280 */
		20848, 20884, 20920, 20956, 20991, 21027, 21063, 21098, 21134, 21170, /* 290 */
		21205, 21241, 21276, 21312, 21348, 21383, 21419, 21454, 21490, 21525, /* 300 */
		21561, 21596, 21632, 21667, 21703, 21738, 21774, 21809, 21844, 21880, /* 310 */
		21915, 21951, 21986, 22021, 22057, 22092, 22127, 22163,	22198, 22233, /* 320 */
		22268, 22304, 22339, 22374, 22409, 22445, 22480, 22515, 22550, 22585, /* 330 */
		22621, 22656, 22691, 22726, 22761, 22796, 22831, 22866, 22902, 22937, /* 340 */
		22972, 23007, 23042, 23077, 23112, 23147, 23182, 23217, 23252, 23287, /* 350 */
		23321, 23356, 23391, 23426,	23461, 23496, 23531, 23566, 23600, 23635, /* 360 */
		23670, 23705, 23740, 23774, 23809, 23844, 23879, 23913, 23948, 23983, /* 370 */
		24018, 24052, 24087, 24122, 24156, 24191, 24226, 24260, 24295, 24329, /* 380 */
		24364, 24399, 24433, 24468, 24502, 24537, 24571, 24606, 24640, 24675, /* 390 */
		24709, 24744, 24778, 24813, 24847, 24881, 24916, 24950, 24585, 25019, /* 400 */
		25053, 25088, 25122, 25156, 25191, 25225, 25259, 25293,	25328, 25362, /* 410 */
		25396, 25430, 25465, 25499, 25533, 25567, 25601, 25635, 25670, 25704, /* 420 */
		25738, 25772, 25806, 25840, 25874, 25908, 25942, 25976, 26010, 26044, /* 430 */
		26078, 26112, 26146, 26180, 26214, 26248, 26282, 26316, 26350, 26384, /* 440 */
		26418, 26452, 26486, 26520,	26553, 26587, 26621, 26655, 26689, 26722, /* 450 */
		26756, 26790, 26824, 26857, 26891, 26925, 26959, 26992, 27026, 27060, /* 460 */
		27093, 27127, 27161, 27194, 27228, 27261, 27295, 27329, 27362, 27396, /* 470 */
		27429, 27463, 27496, 27530, 27563, 27597, 27630, 27664, 27697, 27731, /* 480 */
		27764, 27798, 27831, 27864, 27898, 27931, 27964, 27998, 28031, 28064, /* 490 */
		28098, 28131, 28164, 28198, 28231, 28264, 28297, 28331,	28364, 28397, /* 500 */
		28430, 28463, 28497, 28530, 28563, 28596, 28629, 28662, 28685, 28729, /* 510 */
		28762, 28795, 28828, 28861, 28894, 28927, 28960, 28993, 29026, 29059, /* 520 */
		29092, 29125, 29158, 29191, 29224, 29256, 29289, 29322, 29355, 29388, /* 530 */
		29421, 29454, 29486, 29519,	29552, 29585, 29618, 29650, 29683, 29716, /* 540 */
		29749, 29781, 29814, 29847, 29880, 29912, 29945, 29978, 30010, 30043, /* 550 */
		30075, 30108, 30141, 30173, 30206, 30238, 30271, 30303, 30336, 30369, /* 560 */
		30401, 30434, 30466, 30498, 30531, 30563, 30596, 30628, 30661, 30693, /* 570 */
		30725, 30758, 30790, 30823, 30855, 30887, 30920, 30952, 30984, 31016, /* 580 */
		31049, 31081, 31113, 31145, 31178, 31210, 31242, 31274, 31306, 31339, /* 590 */
		31371, 31403, 31435, 31467, 31499, 31531, 31564, 31596, 31628, 31660, /* 600 */
		31692, 31724, 31756, 31788, 31820, 31852, 31884, 31916, 31948, 31980, /* 610 */
		32012, 32043, 32075, 32107, 32139, 32171, 32203, 32235,	32267, 32298, /* 620 */
		32330, 32362, 32394, 32426, 32457, 32489, 32521, 32553, 32584, 32616, /* 630 */
		32648, 32679, 32711, 32743, 32774, 32806, 32838, 32869, 32901, 32932, /* 640 */
		32964, 32996, 33027, 33059, 33090, 33122, 33153, 33185, 33216, 33248, /* 650 */
		33279  /* 660 */
};
#endif

#ifdef USE_MANY_TEMPRATURE
const unsigned int table_pt100[]={
		9216, 9255, 9295, 9334, 9373, 9412, 9452, 9491, 9530, 9569, /* -20 */
		9609, 9648, 9687, 9726, 9765, 9804, 9844, 9883, 9922, 9961, /* -10 */
		10000, 10039, 10078, 10117,	10156, 10195, 10234, 10273, 10312, 10351, /* 0 */
		10390, 10429, 10468, 10507, 10546, 10585, 10624, 10663, 10702, 10740, /* 10 */
		10779, 10818, 10857, 10896, 10935, 10973, 11012, 11051, 11090, 11129, /* 20 */
		11167, 11206, 11245, 11283, 11322, 11361, 11400, 11438, 11477, 11515, /* 30 */
		11554, 11593, 11631, 11670, 11708, 11747, 11786, 11824, 11863, 11901, /* 40 */
		11940, 11978, 12017, 12055, 12094, 12132, 12171, 12209,	12247, 12286, /* 50 */
		12324, 12363, 12401, 12439, 12478, 12516, 12554, 12593, 12631, 12669, /* 60 */
		12708, 12746, 12784, 12822, 12861, 12899, 12937, 12975, 13013, 13052, /* 70 */
		13090, 13128, 13166, 13204, 13242, 13280, 13318, 13357, 13395, 13433, /* 80 */
		13471, 13509, 13547, 13585,	13623, 13661, 13699, 13737, 13775, 13813, /* 90 */
		13851, 13888, 13926, 13964, 14002, 14040, 14078, 14116, 14154, 14191, /* 100 */
		};
#endif

/*光敏电阻 LXD3537*/


/*湿敏电阻HR202*/


/* zigbee 通信*/


int i=0;

long temp;
long IntDegF;
long IntDegC;

/*
 * main.c
 */
int main(void) {
    WDTCTL = WDTPW | WDTHOLD;	// Stop watchdog timer

    if (CALBC1_1MHZ==0xFF)					// If calibration constant erased
       	while(1);                           // do not load, trap CPU!!

    DCOCTL = 0;                               // Select lowest DCOx and MODx settings
    BCSCTL1 = CALBC1_1MHZ;                    // Set DCO
    DCOCTL = CALDCO_1MHZ;

    FCTL2 = FWKEY + FSSEL0 + FN1;             // MCLK/3 for Flash Timing Generator

    IO_init();
    adc_init();
    TIMA_init();
    __enable_interrupt();

    UART_init();                     			// Start Timer_A UART
    printf("sensor board init\r\n");

    while(1){
    	   /* 开始转换PT100分压值*/
    	   ADC10CTL0 |= ENC + ADC10SC;             // Sampling and conversion start
    	   __bis_SR_register(CPUOFF + GIE);        // LPM0 with interrupts enabled

    	   // oF = ((A10/1024)*1500mV)-923mV)*1/1.97mV = A10*761/1024 - 468
    	   temp = ADC10MEM;
    	   IntDegF = ((temp - 630) * 761) / 1024;

    	   // oC = ((A10/1024)*1500mV)-986mV)*1/3.55mV = A10*423/1024 - 278
    	   temp = ADC10MEM;
    	   IntDegC = ((temp - 673) * 423) / 1024;

    	   __no_operation();                       // SET BREAKPOINT HERE
    }


	return 0;
}

void TIMA_init(void)
{
	CCTL0 = CCIE; 		//	中断使能
	CCR0 = 32768; 		//  定时时间的选取
	//CCTL1 = CCIE;   	// 开启比较器1中断
	//CCR1 = 100; 		// 3.66mS显示延迟
	TACTL = TASSEL_1 + MC_1; // 选择时钟源和计数模式,时钟源为ACLK并且为增计数模式
}
void set_tima1_ms(int t)//ACLK=32.768KHz, t = 1ms ,count=33
{
	long tt;
	tt = (32768 * t)/1000;
	CCR1 = (unsigned int)tt;
	CCTL1 = CCIE;   	// 开启比较器1中断

}
//------------------------------------------------------------------------------
// Timer_A - Interrupt Handler
//------------------------------------------------------------------------------
#pragma vector = TIMER0_A1_VECTOR
__interrupt void Timer_A1_ISR(void)
{
	// 延时中断
	LPM3_EXIT;
}

#pragma vector=ADC10_VECTOR
__interrupt void ADC10_ISR(void)
{
	__bic_SR_register_on_exit(CPUOFF);        // Clear CPUOFF bit from 0(SR)
}
